# K8s ConfigMaps

## Task 1

### visits endpoint

Python app:

```python
@app.get('/visits')
def read_visits():
    try:
        with open('./volume/visits') as f:
            visits = int(f.read())
    except FileNotFoundError:
        visits = 0

    return PlainTextResponse(str(visits))
```

Rust app:

```rust
#[rocket::get("/visits")]
fn visits() -> String {
    if let Ok(mut file) = File::open("volume/visits") {
        let mut content = String::new();
        file.read_to_string(&mut content).unwrap();
        content
    } else {
        "0".to_string()
    }
}
```

### Testing

```bash
docker ps -a
CONTAINER ID   IMAGE                           COMMAND                  CREATED         STATUS                            PORTS                                       NAMES
ccc9cee6a753   dvechtomova/python_app:latest   "gunicorn -k uvicornâ€¦"   5 seconds ago   Up 3 seconds (health: starting)   0.0.0.0:8080->8080/tcp, :::8080->8080/tcp   app_python
2a107c37ab38   dvechtomova/rust_app:latest     "/app/app_rust"          5 seconds ago   Up 3 seconds (health: starting)   0.0.0.0:8081->8080/tcp, :::8081->8080/tcp   app_rust

curl localhost:8080
2023-11-15T11:50:23.486697+03:00 
curl localhost:8080
2023-11-15T11:50:25.412268+03:00

curl localhost:8081
2023-11-15T11:50:27.262895816+03:00
curl localhost:8081
2023-11-15T11:50:28.166692355+03:00
curl localhost:8081
2023-11-15T11:50:29.108978708+03:00

curl localhost:8080/visits
2
curl localhost:8081/visits
3
```

## Task 2

### Chart deployed

```bash
helm install web . --values values.yaml 
NAME: web
LAST DEPLOYED: Wed Nov 15 12:04:10 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=app-helm,app.kubernetes.io/instance=web" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```

### ConfigMap created

```bash
kubectl get configmap
NAME               DATA   AGE
config-configmap   1      7m13s
kube-root-ca.crt   1      8m21s
```

### Verifying

```bash
kubectl get pods -A
NAMESPACE     NAME                               READY   STATUS    RESTARTS        AGE
default       web-app-helm-7c9596c489-8dx4h      1/1     Running   0               5m13s
kube-system   coredns-5d78c9869d-l25tt           1/1     Running   0               6m20s
kube-system   etcd-minikube                      1/1     Running   0               6m35s
kube-system   kube-apiserver-minikube            1/1     Running   0               6m38s
kube-system   kube-controller-manager-minikube   1/1     Running   0               6m39s
kube-system   kube-proxy-cj7k4                   1/1     Running   0               6m20s
kube-system   kube-scheduler-minikube            1/1     Running   0               6m38s
kube-system   storage-provisioner                1/1     Running   1 (5m57s ago)   6m31s

kubectl exec -it web-app-helm-7c9596c489-8dx4h /bin/sh
# cat /config.json
{"secret": "secret"}
```

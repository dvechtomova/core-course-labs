# Secrets (lab 11)

## Task 1

### kubectl secret creation

```bash
kubectl apply -f secret-base.yaml 
secret/secret-base created

kubectl get secrets secret-base -o yaml
apiVersion: v1
data:
  password: cGFzc3dvcmQ=
kind: Secret
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","data":{"password":"cGFzc3dvcmQ="},"kind":"Secret","metadata":{"annotations":{},"name":"secret-base","namespace":"default"},"type":"Opaque"}
  creationTimestamp: "2023-11-03T12:04:33Z"
  name: secret-base
  namespace: default
  resourceVersion: "451"
  uid: 20a2c303-9643-4fd8-bc70-379cccfb14e5
type: Opaque

kubectl get secrets secret-base -o jsonpath='{.data.password}' | base64 -d
password
```

### helm secret creation

```bash
helm install web .

kubectl get svc,deployments,secrets
NAME                               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
service/kubernetes                 ClusterIP   10.96.0.1        <none>        443/TCP             19m
service/vault                      ClusterIP   10.110.126.166   <none>        8200/TCP,8201/TCP   14m
service/vault-agent-injector-svc   ClusterIP   10.104.44.10     <none>        443/TCP             14m
service/vault-internal             ClusterIP   None             <none>        8200/TCP,8201/TCP   14m
service/web-app-helm               ClusterIP   10.96.211.191    <none>        80/TCP              104s

NAME                                   READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/vault-agent-injector   1/1     1            1           14m
deployment.apps/web-app-helm           1/1     1            1           104s

NAME                                 TYPE                 DATA   AGE
secret/secret-base                   Opaque               1      104s
secret/sh.helm.release.v1.vault.v1   helm.sh/release.v1   1      14m
secret/sh.helm.release.v1.web.v1     helm.sh/release.v1   1      2m7s

kubectl get pods -A
NAMESPACE     NAME                                    READY   STATUS    RESTARTS        AGE
default       vault-0                                 1/1     Running   0               13m
default       vault-agent-injector-5cd8b87c6c-kpkpr   1/1     Running   0               13m
default       web-app-helm-76b449c4f7-55fmc           1/1     Running   0               67s
kube-system   coredns-5d78c9869d-bf7ps                1/1     Running   0               18m
kube-system   etcd-minikube                           1/1     Running   0               18m
kube-system   kube-apiserver-minikube                 1/1     Running   0               18m
kube-system   kube-controller-manager-minikube        1/1     Running   1 (19m ago)     18m
kube-system   kube-proxy-bf8kt                        1/1     Running   0               18m
kube-system   kube-scheduler-minikube                 1/1     Running   0               18m
kube-system   storage-provisioner                     1/1     Running   3 (3m44s ago)   17m

kubectl exec web-app-helm-76b449c4f7-55fmc -- env | grep PASSWORD
PASSWORD=password
```

## Task 2

### Vault installed

```bash
kubectl get pods -n default
NAMESPACE     NAME                                    READY   STATUS    RESTARTS        AGE
default       vault-0                                 1/1     Running   0               13m
default       vault-agent-injector-5cd8b87c6c-kpkpr   1/1     Running   0               13m
```

### Secret creation

```bash
kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-03T12:30:29.984563447Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-03T12:30:29.984563447Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
```

### SA authentification

```bash
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
/ $ vault policy write internal-app - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: internal-app
/ $ vault write auth/kubernetes/role/internal-app \
>       bound_service_account_names=web-app-helm \
>       bound_service_account_namespaces=default \
>       policies=internal-app \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/internal-app
```

So here we changed `bound_service_account_names` to correct service account created by Helm chart.

### Verifying

```bash
kubectl get sa -n default
NAME                   SECRETS   AGE
default                0         39m
vault                  0         35m
vault-agent-injector   0         35m
web-app-helm           0         5m7s

kubectl get pods -A
NAMESPACE     NAME                                    READY   STATUS    RESTARTS      AGE
default       postinstall-hook                        1/1     Running   0             9s
default       vault-0                                 1/1     Running   0             30m
default       vault-agent-injector-5cd8b87c6c-kpkpr   1/1     Running   0             30m
default       web-app-helm-84699c4979-cbv28           2/2     Running   0             9s
kube-system   coredns-5d78c9869d-bf7ps                1/1     Running   0             34m
kube-system   etcd-minikube                           1/1     Running   0             35m
kube-system   kube-apiserver-minikube                 1/1     Running   0             35m
kube-system   kube-controller-manager-minikube        1/1     Running   1 (35m ago)   35m
kube-system   kube-proxy-bf8kt                        1/1     Running   0             34m
kube-system   kube-scheduler-minikube                 1/1     Running   0             35m
kube-system   storage-provisioner                     1/1     Running   3 (20m ago)   34m

kubectl exec web-app-helm-84699c4979-cbv28 -it /bin/sh
Defaulted container "app-helm" out of: app-helm, vault-agent, vault-agent-init (init)
# cat /vault/secrets/database-config.txt
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2023-11-03T12:30:29.984563447Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
```

## Bonus
